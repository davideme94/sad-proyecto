<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Buscador de Resoluciones</title>
<style>
  body{font-family:system-ui,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:20px;margin-bottom:16px}
  input,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #d9dbe1}
  button{background:#1544f1;color:#fff;border:none;cursor:pointer}
  button.secondary{background:#eef1ff;color:#1544f1;border:1px solid #cdd5ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:#6b7280;font-size:14px}
  .hidden{display:none}
  .badge{font-size:12px;border:1px solid #e5e7ef;border-radius:999px;padding:3px 8px}
  .field{display:flex;gap:6px;align-items:center;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Buscar por DNI</h2>
    <div class="row">
      <input id="dni" placeholder="Ingrese DNI" />
      <button id="btnBuscar">Buscar</button>
      <div class="muted" id="adminInfo" style="margin-left:auto"></div>
    </div>
    <div id="resultado" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div class="row">
      <h3 style="margin:0">Panel Admin</h3>
      <span class="badge" id="authBadge">No conectado</span>
      <div style="margin-left:auto">
        <button id="btnLogin">Login</button>
        <button class="secondary hidden" id="btnLogout">Salir</button>
      </div>
    </div>

    <div id="adminPanel" class="hidden" style="margin-top:12px">
      <h4>Docente</h4>
      <div class="row">
        <input id="docDni" placeholder="DNI docente" />
        <input id="docNombre" placeholder="Nombre docente" />
        <button id="btnGuardarDoc">Guardar/Actualizar</button>
      </div>
      <h4 style="margin-top:12px">Resoluci√≥n</h4>
      <div class="row">
        <input id="titulo" placeholder="T√≠tulo/Descripci√≥n" style="flex:2" />
        <input id="driveUrl" placeholder="URL de Google (Drive/Docs)" style="flex:2" />
        <input id="expediente" placeholder="Expediente" />
        <input id="anio" type="number" placeholder="A√±o" style="width:120px" />
        <button id="btnCrearRes">Crear</button>
      </div>
      <div style="margin-top:12px">
        <button class="secondary" id="btnListRes">Ver resoluciones</button>
        <button class="secondary" id="btnListAcuses">Ver acuses</button>
      </div>
      <div id="adminLista" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
let TOKEN = null;
const $ = id => document.getElementById(id);
const show = (el, s=true)=> el.classList.toggle('hidden', !s);
function setAuthUI(email){
  $('authBadge').textContent = email ? 'Conectado' : 'No conectado';
  $('adminInfo').textContent = email || '';
  show($('btnLogout'), !!email);
  show($('adminPanel'), !!email);
}

$('btnBuscar').onclick = async () => {
  const dni = $('dni').value.trim();
  if(!/^[0-9]{7,9}$/.test(dni)) { alert("DNI inv√°lido"); return; }
  const res = await fetch(`/api/public/buscar?dni=${encodeURIComponent(dni)}`);
  const data = await res.json();
  const cont = $('resultado');
  const nombre = data.nombre ? `Nombre: <b>${data.nombre}</b>` : 'Docente no registrado';
  if(!data.resoluciones?.length){
    cont.innerHTML = `<p>${nombre}</p><p class="muted">Sin resoluciones.</p>`;
    return;
  }
  cont.innerHTML = `
    <p>${nombre}</p>
    ${data.resoluciones.map(r => `
      <div style="margin:8px 0; border:1px solid #e5e7ef; border-radius:10px; padding:10px">
        <div><b>${r.titulo}</b></div>
        <div class="muted">${[r.expediente, r.anio].filter(Boolean).join(' ‚Ä¢ ')}</div>
        <div class="field">
          <input id="nom_${r._id}" placeholder="Nombre y Apellido" />
          <input id="mail_${r._id}" placeholder="Correo electr√≥nico" />
          <label><input type="checkbox" id="chk_${r._id}"> Acepto: ‚ÄúLa sola exhibici√≥n de los listados dar√° por cumplida la notificaci√≥n.‚Äù</label>
          <button onclick="registrarYDescargar('${data.dni}','${r._id}')">Descargar</button>
        </div>
      </div>
    `).join('')}
  `;
};

async function registrarYDescargar(dni, resolucionId){
  const nom = $(`nom_${resolucionId}`).value.trim();
  const email = $(`mail_${resolucionId}`).value.trim();
  const acepto = $(`chk_${resolucionId}`).checked;
  if(!nom || !email || !acepto){ alert("Complet√° nombre, email y tild√° aceptaci√≥n"); return; }
  const textoLegal = "La sola exhibici√≥n de los listados dar√° por cumplida la notificaci√≥n.";
  const res = await fetch(`/api/public/acuse`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ docenteDni:dni, resolucionId, nombreCompleto:nom, email, acepto:true, textoLegal })
  });
  const data = await res.json();
  if(data.ok && data.driveUrl){
    window.open(data.driveUrl, '_blank', 'noopener');
    alert("Descargo registrado ‚úÖ");
  }else{
    alert(data.error || "Error al registrar");
  }
}

// Admin
$('btnLogin').onclick = async ()=>{
  const email = prompt("Email admin:");
  const password = prompt("Contrase√±a:");
  if(!email || !password) return;
  const res = await fetch(`/api/auth/login`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email, password })
  });
  const data = await res.json();
  if(data.token){ TOKEN = data.token; setAuthUI(data.email); } else { alert(data.error||"Error"); }
};
$('btnLogout').onclick = ()=>{ TOKEN=null; setAuthUI(null); };

$('btnGuardarDoc').onclick = async ()=>{
  const dni = $('docDni').value.trim();
  const nombre = $('docNombre').value.trim();
  if(!/^[0-9]{7,9}$/.test(dni) || !nombre) { alert("Datos inv√°lidos"); return; }
  const res = await fetch(`/api/admin/docentes`,{
    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`},
    body: JSON.stringify({ dni, nombre })
  });
  const data = await res.json();
  if(data._id) alert("Docente guardado ‚úÖ"); else alert(data.error||"Error");
};

$('btnCrearRes').onclick = async ()=>{
  const docenteDni = $('docDni').value.trim();
  const titulo = $('titulo').value.trim();
  const driveUrl = $('driveUrl').value.trim();
  const expediente = $('expediente').value.trim() || null;
  const anio = $('anio').value ? parseInt($('anio').value,10) : null;
  if(!/^[0-9]{7,9}$/.test(docenteDni) || !titulo || !driveUrl){ alert("Complet√° DNI, t√≠tulo y URL"); return; }
  const res = await fetch(`/api/admin/resoluciones`,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`},
    body: JSON.stringify({ docenteDni, titulo, driveUrl, expediente, anio })
  });
  const data = await res.json();
  if(data._id) alert("Resoluci√≥n creada ‚úÖ"); else alert(data.error||"Error");
};

$('btnListRes').onclick = async ()=>{
  const res = await fetch(`/api/admin/resoluciones`,{ headers:{'Authorization':`Bearer ${TOKEN}`}});
  const list = await res.json();
  $('adminLista').innerHTML = list.map(r => `<div>üßæ <b>${r.titulo}</b> ‚Äî DNI ${r.docenteDni} ‚Äî <code>${r._id}</code></div>`).join('');
};
$('btnListAcuses').onclick = async ()=>{
  const res = await fetch(`/api/admin/acuses`,{ headers:{'Authorization':`Bearer ${TOKEN}`}});
  const list = await res.json();
  $('adminLista').innerHTML = list.map(a => `<div>‚úÖ ${new Date(a.firmadoEn).toLocaleString()} ‚Äî DNI ${a.docenteDni} ‚Äî <b>${a.nombreCompleto}</b> ‚Äî ${a.email} ‚Äî Res: <code>${a.resolucionId}</code></div>`).join('');
};
</script>
</body>
</html>
